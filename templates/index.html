<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brasswick - AI Image Forge</title>
    <style>
        :root {
            --brass: #b8860b;
            --dark-brass: #8b6914;
            --copper: #b87333;
            --bronze: #cd7f32;
            --iron: #3a3a3a;
            --steel: #71797e;
            --bg-dark: #1a1410;
            --bg-panel: #2a2218;
            --bg-input: #1a1410;
            --text: #e8d7c3;
            --text-dim: #a89988;
            --accent: linear-gradient(135deg, #b8860b 0%, #cd7f32 100%);
            --glow: rgba(184, 134, 11, 0.4);
        }

        body.minimal-mode {
            --brass: #4a90e2;
            --dark-brass: #357abd;
            --copper: #5ca3e5;
            --bronze: #6bb3f0;
            --iron: #2a2a2a;
            --steel: #5a5a5a;
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-input: #2a2a2a;
            --text: #e0e0e0;
            --text-dim: #999;
            --accent: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            --glow: rgba(74, 144, 226, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.6;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 4px),
                radial-gradient(circle at 20% 50%, rgba(184, 134, 11, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(205, 127, 50, 0.03) 0%, transparent 50%);
        }

        body.minimal-mode {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-image: none;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 3px solid var(--brass);
            margin-bottom: 30px;
            position: relative;
            background: linear-gradient(to bottom, transparent, rgba(184, 134, 11, 0.05));
        }

        body.minimal-mode header {
            padding: 20px 0;
            background: none;
        }

        header::before, header::after {
            content: '‚öô';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3em;
            color: var(--brass);
            opacity: 0.3;
        }

        body.minimal-mode header::before,
        body.minimal-mode header::after {
            display: none;
        }

        header::before {
            left: 20px;
        }

        header::after {
            right: 20px;
            transform: translateY(-50%) scaleX(-1);
        }

        h1 {
            font-size: 2.5em;
            background: var(--accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
            font-weight: bold;
        }

        body.minimal-mode h1 {
            font-size: 2em;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 0.9em;
            color: var(--text-dim);
            letter-spacing: 2px;
            margin-top: 5px;
        }

        body.minimal-mode .subtitle {
            display: none;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: var(--bg-panel);
            border: 2px solid var(--brass);
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            color: var(--brass);
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--iron);
            box-shadow: 0 0 10px var(--glow);
        }

        .gear-decoration {
            position: fixed;
            font-size: 200px;
            color: var(--dark-brass);
            opacity: 0.03;
            pointer-events: none;
            animation: rotate-slow 60s linear infinite;
        }

        body.minimal-mode .gear-decoration {
            display: none;
        }

        .gear-1 {
            top: 10%;
            left: 5%;
        }

        .gear-2 {
            bottom: 10%;
            right: 5%;
            animation-direction: reverse;
        }

        @keyframes rotate-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--brass);
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            background: var(--bg-panel);
            border: 2px solid var(--dark-brass);
            border-bottom: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
            position: relative;
        }

        body:not(.minimal-mode) .tab {
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
        }

        body.minimal-mode .tab {
            border-radius: 4px 4px 0 0;
            padding: 12px 24px;
        }

        .tab:hover {
            color: var(--brass);
            background: var(--iron);
        }

        .tab.active {
            color: var(--brass);
            background: var(--iron);
            border-color: var(--brass);
            box-shadow: 0 0 15px var(--glow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 25px;
            border: 2px solid var(--dark-brass);
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--brass), transparent);
        }

        body.minimal-mode .panel {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.minimal-mode .panel::before {
            display: none;
        }

        .section-header {
            font-size: 1.1em;
            color: var(--brass);
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--dark-brass);
        }

        .collapsible-section {
            margin-bottom: 20px;
        }

        .collapse-header {
            background: var(--iron);
            padding: 12px 15px;
            cursor: pointer;
            border: 2px solid var(--dark-brass);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapse-header::after {
            content: '‚ñº';
            transition: transform 0.3s;
        }

        .collapse-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .collapse-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapse-content.collapsed {
            max-height: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--brass);
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 2px solid var(--dark-brass);
            border-radius: 4px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--brass);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .dimension-controls {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 10px;
        }

        .aspect-ratios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .preset-btn {
            padding: 10px 8px;
            background: var(--iron);
            border: 2px solid var(--dark-brass);
            color: var(--text-dim);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            text-align: center;
        }

        .preset-btn:hover,
        .preset-btn.active {
            background: var(--bg-input);
            border-color: var(--brass);
            color: var(--brass);
        }

        .lora-section {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid var(--dark-brass);
        }

        .lora-header {
            font-size: 0.9em;
            color: var(--copper);
            margin-bottom: 10px;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            color: var(--text);
            border: 2px solid var(--brass);
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--glow);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: var(--iron);
            border-color: var(--steel);
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .button-secondary {
            background: linear-gradient(135deg, #8b6914 0%, #b87333 100%);
        }

        .preview-container {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 25px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--dark-brass);
            position: relative;
        }

        .preview-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            padding: 8px;
            background: var(--iron);
            border: 2px solid var(--dark-brass);
            border-radius: 4px;
            cursor: pointer;
        }

        #preview {
            max-width: 100%;
            max-height: 800px;
            border-radius: 4px;
            display: none;
            border: 3px solid var(--dark-brass);
        }

        #preview.visible {
            display: block;
        }

        .status {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            width: 100%;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            border: 2px solid var(--dark-brass);
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .seed-controls {
            display: flex;
            gap: 10px;
        }

        .seed-controls input {
            flex: 1;
        }

        .seed-controls button {
            width: auto;
            padding: 12px 20px;
        }

        .placeholder {
            text-align: center;
            color: var(--text-dim);
            padding: 40px;
        }

        .placeholder svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
            stroke: var(--brass);
        }

        .error {
            background: rgba(139, 0, 0, 0.3);
            border: 2px solid #8b0000;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .eta-info {
            font-size: 0.9em;
            color: var(--copper);
            margin-top: 10px;
        }

        .queue-info {
            background: var(--bg-input);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--dark-brass);
        }

        .queue-badge {
            background: var(--brass);
            color: var(--bg-dark);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .history-item {
            background: var(--bg-panel);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--dark-brass);
        }

        .history-item:hover {
            transform: translateY(-5px);
            border-color: var(--brass);
        }

        .history-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: var(--bg-input);
        }

        .history-info {
            padding: 15px;
        }

        .history-time {
            font-size: 0.85em;
            color: var(--copper);
            margin-bottom: 8px;
        }

        .history-params {
            font-size: 0.8em;
            color: var(--text-dim);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 30px;
            max-width: 90vw;
            width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 3px solid var(--brass);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--iron);
            border: 2px solid var(--dark-brass);
            color: var(--text);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
        }

        .modal-image {
            max-width: 100%;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 2px solid var(--dark-brass);
        }

        .modal-params {
            background: var(--bg-input);
            padding: 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.8;
            border: 2px solid var(--dark-brass);
            word-break: break-word;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
        }

        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .templates-grid {
            display: grid;
            gap: 10px;
        }

        .template-item {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid var(--dark-brass);
        }

        .template-item:hover {
            border-color: var(--brass);
        }

        .template-name {
            font-weight: 600;
            color: var(--brass);
            margin-bottom: 5px;
        }

        .template-preview {
            font-size: 0.85em;
            color: var(--text-dim);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .server-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .shortcuts-help {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 4px;
            border: 2px solid var(--dark-brass);
            margin-top: 20px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--dark-brass);
        }

        .shortcut-key {
            color: var(--brass);
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .input-group,
            .button-group,
            .dimension-controls {
                grid-template-columns: 1fr;
            }

            .aspect-ratios {
                grid-template-columns: repeat(2, 1fr);
            }

            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .history-item img {
                height: 150px;
            }

            .server-controls {
                grid-template-columns: 1fr;
            }

            .modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="gear-decoration gear-1">‚öô</div>
    <div class="gear-decoration gear-2">‚öô</div>
    
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">üé®</span> <span id="theme-text">Minimal</span>
    </button>

    <div class="container">
        <header>
            <h1>‚öô BRASSWICK ‚öô</h1>
            <div class="subtitle">‚Äî AI IMAGE FORGE ‚Äî</div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('generate')">‚öí Generate</button>
            <button class="tab" onclick="switchTab('tagger')">üè∑ Tagger</button>
            <button class="tab" onclick="switchTab('history')">üìú History</button>
            <button class="tab" onclick="switchTab('templates')">üìã Templates</button>
            <button class="tab" onclick="switchTab('settings')">‚öô Settings</button>
        </div>

        <div id="generate-tab" class="tab-content active">
            <div class="main-content">
                <div class="controls-panel">
                    <div class="panel">
                        <div id="queue-info" class="queue-info" style="display:none;">
                            <span>‚è≥ Queue</span>
                            <span class="queue-badge" id="queue-count">0</span>
                        </div>

                        <form id="generation-form">
                            <div class="form-group">
                                <label for="model">‚öó Model</label>
                                <select id="model" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="positive">‚úí Positive Prompt</label>
                                <textarea id="positive" placeholder="Describe your vision..." required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="negative">‚úñ Negative Prompt</label>
                                <textarea id="negative" placeholder="What to avoid..."></textarea>
                            </div>

                            <div class="collapsible-section">
                                <div class="collapse-header" onclick="toggleCollapse(this)">
                                    <span>‚öô Advanced Settings</span>
                                </div>
                                <div class="collapse-content">
                                    <div class="form-group" style="margin-top:15px;">
                                        <label for="sampler">üîß Sampler</label>
                                        <select id="sampler"></select>
                                    </div>

                                    <div class="form-group">
                                        <label for="scheduler">‚è± Scheduler</label>
                                        <select id="scheduler"></select>
                                    </div>

                                    <div class="form-group">
                                        <label for="cfg">‚öñ CFG Scale</label>
                                        <input type="number" id="cfg" value="8" min="1" max="30" step="0.5">
                                    </div>

                                    <div class="form-group">
                                        <label for="seed-control">üé≤ After Generation</label>
                                        <select id="seed-control">
                                            <option value="random">Randomize Seed</option>
                                            <option value="fixed">Keep Fixed</option>
                                            <option value="increment">Increment Seed</option>
                                            <option value="decrement">Decrement Seed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>üå± Seed</label>
                                <div class="seed-controls">
                                    <input type="number" id="seed" value="-1" min="-1" max="4294967295">
                                    <button type="button" onclick="randomSeed()">üé≤</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="steps">üë£ Steps</label>
                                <input type="number" id="steps" value="20" min="1" max="150">
                            </div>

                            <div class="form-group">
                                <label>üìê Dimensions</label>
                                <div class="dimension-controls">
                                    <select id="size-preset">
                                        <option value="sdxl">SDXL (1024)</option>
                                        <option value="sd">SD (512)</option>
                                    </select>
                                    <div class="input-group">
                                        <input type="number" id="width" value="1024" min="256" max="2048" step="64" readonly>
                                        <input type="number" id="height" value="1024" min="256" max="2048" step="64" readonly>
                                    </div>
                                </div>
                                <div class="aspect-ratios" id="aspect-ratios"></div>
                            </div>

                            <div class="form-group">
                                <label for="batch">üì¶ Batch Size</label>
                                <input type="number" id="batch" value="1" min="1" max="8">
                            </div>

                            <div class="collapsible-section">
                                <div class="collapse-header collapsed" onclick="toggleCollapse(this)">
                                    <span>üé® LoRA Enhancement</span>
                                </div>
                                <div class="collapse-content collapsed">
                                    <div class="lora-section" style="margin-top:15px;">
                                        <div class="lora-header">LoRA 1</div>
                                        <div class="form-group">
                                            <select id="lora1"></select>
                                        </div>
                                        <div class="form-group">
                                            <label for="lora1_weight">Weight</label>
                                            <input type="number" id="lora1_weight" value="1" min="0" max="2" step="0.1">
                                        </div>
                                    </div>

                                    <div class="lora-section">
                                        <div class="lora-header">LoRA 2</div>
                                        <div class="form-group">
                                            <select id="lora2"></select>
                                        </div>
                                        <div class="form-group">
                                            <label for="lora2_weight">Weight</label>
                                            <input type="number" id="lora2_weight" value="1" min="0" max="2" step="0.1">
                                        </div>
                                    </div>

                                    <div class="lora-section">
                                        <div class="lora-header">LoRA 3</div>
                                        <div class="form-group">
                                            <select id="lora3"></select>
                                        </div>
                                        <div class="form-group">
                                            <label for="lora3_weight">Weight</label>
                                            <input type="number" id="lora3_weight" value="1" min="0" max="2" step="0.1">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="generate-btn">‚ö° Generate</button>
                            <div class="button-group">
                                <button type="button" class="button-secondary" id="cancel-btn" onclick="cancelGeneration()" style="display:none;">‚äó Cancel</button>
                                <button type="button" class="button-secondary" id="clear-queue-btn" onclick="clearQueue()" style="display:none;">üóë Clear Queue</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="preview-container">
                    <div class="preview-controls" id="preview-controls" style="display:none;">
                        <button class="icon-btn" onclick="downloadCurrentImage()" title="Download">üíæ</button>
                    </div>
                    <div id="placeholder" class="placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <p>Your forged image will materialize here</p>
                    </div>
                    <div id="status" class="status" style="display:none;">
                        <div id="status-text"></div>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="eta-info" class="eta-info"></div>
                    </div>
                    <img id="preview" alt="Generated image">
                </div>
            </div>
        </div>

        <div id="tagger-tab" class="tab-content">
            <div class="main-content">
                <div class="panel">
                    <div class="section-header">Image Interrogator</div>
                    
                    <div class="form-group">
                        <label>Upload Image</label>
                        <input type="file" id="tagger-input" accept="image/*" style="padding: 10px;">
                    </div>

                    <div class="input-group">
                        <div class="form-group">
                            <label>Threshold</label>
                            <input type="number" id="tagger-threshold" value="0.35" min="0.1" max="1.0" step="0.05">
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <select id="tagger-model">
                                <option value="wd-eva02-large-tagger-v3">EVA02 Large V3</option>
                                <option value="wd-v1-4-moat-tagger-v2">Moat V2</option>
                                <option value="wd-v1-4-swinv2-tagger-v2">SwinV2</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="interrogateImage()" id="tagger-btn">üîç Interrogate</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Detected Tags</label>
                        <textarea id="tagger-result" readonly style="height: 150px; font-family: monospace;"></textarea>
                        <div class="button-group">
                            <button class="button-secondary" onclick="copyTags('positive')">Copy to Positive</button>
                            <button class="button-secondary" onclick="copyTags('clipboard')">Copy to Clipboard</button>
                        </div>
                    </div>
                </div>
                
                <div class="preview-container">
                    <img id="tagger-preview" style="max-width: 100%; max-height: 500px; display: none; border: 2px solid var(--dark-brass);">
                    <div id="tagger-placeholder" class="placeholder">
                        <p>Upload an image to see it here</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-tab" class="tab-content">
            <div class="panel">
                <div id="history-container"></div>
            </div>
        </div>

        <div id="templates-tab" class="tab-content">
            <div class="panel">
                <div class="section-header">üìã Prompt Templates</div>
                <div class="button-group" style="margin-bottom: 20px;">
                    <button onclick="saveTemplate()">üíæ Save Current</button>
                    <button onclick="showAddTemplate()">‚ûï Add New</button>
                </div>
                <div id="templates-container" class="templates-grid"></div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="panel">
                <div class="section-header">‚öô Server Configuration</div>
                
                <div class="form-group">
                    <label for="config-server">ComfyUI Server Address</label>
                    <input type="text" id="config-server" placeholder="127.0.0.1:8188">
                </div>

                <div class="form-group">
                    <label for="config-path">ComfyUI Installation Path</label>
                    <input type="text" id="config-path" placeholder="/path/to/ComfyUI">
                </div>

                <div class="form-group">
                    <label for="config-venv">ComfyUI Virtual Environment (Optional)</label>
                    <input type="text" id="config-venv" placeholder="/path/to/ComfyUI/venv">
                </div>

                <div class="form-group">
                    <label for="config-port">Brasswick Port</label>
                    <input type="number" id="config-port" value="5000">
                </div>

                <div class="form-group">
                    <label for="config-history">Max History Items</label>
                    <input type="number" id="config-history" value="50" min="10" max="500">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="config-multiuser"> Enable Multi-User Mode
                    </label>
                </div>

                <button onclick="saveConfig()">üíæ Save Configuration</button>

                <div class="section-header">üîß Server Control</div>
                <p style="color: var(--text-dim); margin-bottom: 15px; font-size: 0.9em;">
                    Start/Stop/Restart the ComfyUI server. Set paths above first.
                </p>
                <div class="server-controls">
                    <button onclick="startServer()">‚ñ∂ Start</button>
                    <button onclick="restartServer()">‚ü≥ Restart</button>
                    <button onclick="stopServer()">‚èπ Stop</button>
                </div>

                <div class="section-header">‚å® Keyboard Shortcuts</div>
                <div class="shortcuts-help">
                    <div class="shortcut-item">
                        <span>Generate</span>
                        <span class="shortcut-key">Ctrl+Enter</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Cancel</span>
                        <span class="shortcut-key">Esc</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Random Seed</span>
                        <span class="shortcut-key">Ctrl+R</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Download</span>
                        <span class="shortcut-key">Ctrl+D</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Save Template</span>
                        <span class="shortcut-key">Ctrl+S</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <img id="modal-image" class="modal-image">
            <div id="modal-params" class="modal-params"></div>
            <div class="modal-actions">
                <button onclick="downloadHistoryImage()">üíæ Download</button>
                <button onclick="sendToGenerate()">‚öô Send to Generate</button>
            </div>
        </div>
    </div>

    <div id="template-modal" class="modal" onclick="closeTemplateModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
            <h2 style="color: var(--brass); margin-bottom: 20px;">Save Template</h2>
            <div class="form-group">
                <label for="template-name">Template Name</label>
                <input type="text" id="template-name" placeholder="My Style">
            </div>
            <div class="form-group">
                <label for="template-positive">Positive Prompt</label>
                <textarea id="template-positive" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="template-negative">Negative Prompt</label>
                <textarea id="template-negative" rows="3"></textarea>
            </div>
            <button onclick="confirmSaveTemplate()">üíæ Save Template</button>
        </div>
    </div>

    <script>
        let currentSeed = -1;
        let statusCheckInterval = null;
        let currentHistoryId = null;
        let templates = JSON.parse(localStorage.getItem('brasswick_templates') || '[]');
        let userSettings = JSON.parse(localStorage.getItem('brasswick_settings') || '{}');

        const aspectRatios = {
            sdxl: {
                "1:1": { width: 1024, height: 1024 },
                "2:3": { width: 832, height: 1248 },
                "3:4": { width: 896, height: 1152 },
                "9:16": { width: 768, height: 1344 },
                "3:2": { width: 1248, height: 832 },
                "4:3": { width: 1152, height: 896 },
                "16:9": { width: 1344, height: 768 },
                "1.85:1": { width: 1408, height: 768 },
                "2.39:1": { width: 1536, height: 640 }
            },
            sd: {
                "1:1": { width: 512, height: 512 },
                "2:3": { width: 416, height: 624 },
                "3:4": { width: 448, height: 576 },
                "9:16": { width: 384, height: 672 },
                "3:2": { width: 624, height: 416 },
                "4:3": { width: 576, height: 448 },
                "16:9": { width: 672, height: 384 },
                "1.85:1": { width: 704, height: 384 },
                "2.39:1": { width: 768, height: 320 }
            }
        };

        function toggleTheme() {
            const body = document.body;
            const isMinimal = body.classList.toggle('minimal-mode');
            localStorage.setItem('brasswick_minimal_mode', isMinimal);
            document.getElementById('theme-icon').textContent = isMinimal ? '‚öô' : 'üé®';
            document.getElementById('theme-text').textContent = isMinimal ? 'Steampunk' : 'Minimal';
        }

        function loadTheme() {
            if (localStorage.getItem('brasswick_minimal_mode') === 'true') {
                document.body.classList.add('minimal-mode');
                document.getElementById('theme-icon').textContent = '‚öô';
                document.getElementById('theme-text').textContent = 'Steampunk';
            }
        }

        function toggleCollapse(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
            
            if (tab === 'history') loadHistory();
            else if (tab === 'templates') loadTemplates();
            else if (tab === 'settings') loadSettings();
        }

        function loadAspectRatios() {
            const size = document.getElementById('size-preset').value;
            const container = document.getElementById('aspect-ratios');
            container.innerHTML = Object.keys(aspectRatios[size]).map(ratio => 
                `<button type="button" class="preset-btn" onclick="setAspectRatio('${size}', '${ratio}')">${ratio}</button>`
            ).join('');
        }

        function setAspectRatio(size, ratio) {
            const dim = aspectRatios[size][ratio];
            document.getElementById('width').value = dim.width;
            document.getElementById('height').value = dim.height;
        }

        async function loadModels() {
            try {
                const res = await fetch('/api/models');
                const models = await res.json();
                document.getElementById('model').innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                if (userSettings.model && models.includes(userSettings.model)) {
                    document.getElementById('model').value = userSettings.model;
                }
            } catch (e) {
                console.error('Failed to load models:', e);
            }
        }

        async function loadLoras() {
            try {
                const res = await fetch('/api/loras');
                const loras = await res.json();
                const opts = loras.map(l => `<option value="${l}">${l}</option>`).join('');
                document.getElementById('lora1').innerHTML = opts;
                document.getElementById('lora2').innerHTML = opts;
                document.getElementById('lora3').innerHTML = opts;
                
                // Load saved LoRA selections
                if (userSettings.lora_1_name && loras.includes(userSettings.lora_1_name)) {
                    document.getElementById('lora1').value = userSettings.lora_1_name;
                }
                if (userSettings.lora_2_name && loras.includes(userSettings.lora_2_name)) {
                    document.getElementById('lora2').value = userSettings.lora_2_name;
                }
                if (userSettings.lora_3_name && loras.includes(userSettings.lora_3_name)) {
                    document.getElementById('lora3').value = userSettings.lora_3_name;
                }
            } catch (e) {
                console.error('Failed to load LoRAs:', e);
            }
        }

        async function loadSamplers() {
            try {
                const res = await fetch('/api/samplers');
                const samplers = await res.json();
                document.getElementById('sampler').innerHTML = samplers.map(s => `<option value="${s}">${s}</option>`).join('');
                if (userSettings.sampler && samplers.includes(userSettings.sampler)) {
                    document.getElementById('sampler').value = userSettings.sampler;
                }
            } catch (e) {
                console.error('Failed to load samplers:', e);
            }
        }

        async function loadSchedulers() {
            try {
                const res = await fetch('/api/schedulers');
                const schedulers = await res.json();
                document.getElementById('scheduler').innerHTML = schedulers.map(s => `<option value="${s}">${s}</option>`).join('');
                if (userSettings.scheduler && schedulers.includes(userSettings.scheduler)) {
                    document.getElementById('scheduler').value = userSettings.scheduler;
                }
            } catch (e) {
                console.error('Failed to load schedulers:', e);
            }
        }

        function randomSeed() {
            document.getElementById('seed').value = Math.floor(Math.random() * 4294967295);
        }

        function formatTime(sec) {
            if (sec < 60) return `${sec}s`;
            return `${Math.floor(sec/60)}m ${sec%60}s`;
        }

        function handleSeedControl(lastSeed) {
            const ctrl = document.getElementById('seed-control').value;
            const input = document.getElementById('seed');
            if (ctrl === 'random') input.value = -1;
            else if (ctrl === 'fixed') input.value = lastSeed;
            else if (ctrl === 'increment') input.value = lastSeed + 1;
            else if (ctrl === 'decrement') input.value = Math.max(0, lastSeed - 1);
        }

        async function checkStatus() {
            const res = await fetch('/api/status');
            const status = await res.json();
            
            const queueInfo = document.getElementById('queue-info');
            const queueCount = document.getElementById('queue-count');
            if (status.queue_pending > 0) {
                queueInfo.style.display = 'flex';
                queueCount.textContent = status.queue_pending;
                document.getElementById('clear-queue-btn').style.display = 'block';
            } else {
                queueInfo.style.display = 'none';
                document.getElementById('clear-queue-btn').style.display = 'none';
            }

            const statusDiv = document.getElementById('status');
            const preview = document.getElementById('preview');
            const placeholder = document.getElementById('placeholder');
            const controls = document.getElementById('preview-controls');
            const genBtn = document.getElementById('generate-btn');
            const cancelBtn = document.getElementById('cancel-btn');

            if (status.status === 'generating') {
                statusDiv.style.display = 'block';
                placeholder.style.display = 'none';
                preview.classList.remove('visible');
                controls.style.display = 'none';
                document.getElementById('status-text').textContent = '‚öô Forging...';
                document.getElementById('progress-fill').style.width = status.progress + '%';
                document.getElementById('eta-info').textContent = status.eta_seconds > 0 
                    ? `‚è± ETA: ${formatTime(status.eta_seconds)} ‚Ä¢ ${status.progress}%`
                    : `Progress: ${status.progress}%`;
                genBtn.disabled = true;
                cancelBtn.style.display = 'block';
            } else if (status.status === 'complete' && status.has_image) {
                statusDiv.style.display = 'none';
                placeholder.style.display = 'none';
                preview.src = '/api/image?' + Date.now();
                preview.classList.add('visible');
                controls.style.display = 'flex';
                genBtn.disabled = false;
                cancelBtn.style.display = 'none';
                if (currentSeed !== -1) handleSeedControl(currentSeed);
            } else if (status.status === 'error' || status.status === 'cancelled') {
                statusDiv.style.display = 'none';
                placeholder.innerHTML = `<div class="error">‚ö† ${status.error || 'Cancelled'}</div>`;
                genBtn.disabled = false;
                cancelBtn.style.display = 'none';
            } else {
                genBtn.disabled = false;
                cancelBtn.style.display = 'none';
            }
        }

        async function cancelGeneration() {
            await fetch('/api/cancel', { method: 'POST' });
        }

        async function clearQueue() {
            await fetch('/api/clear_queue', { method: 'POST' });
        }

        async function downloadCurrentImage() {
            window.open('/api/image/download', '_blank');
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const history = await res.json();
                const container = document.getElementById('history-container');
                
                if (history.length === 0) {
                    container.innerHTML = '<div class="empty-history">‚öô No images yet</div>';
                    return;
                }
                
                container.innerHTML = '<div class="history-grid">' + 
                    history.map(item => `
                        <div class="history-item" onclick="showHistoryModal('${item.id}')">
                            <img src="/api/history/${item.id}" alt="Generated" loading="lazy">
                            <div class="history-info">
                                <div class="history-time">‚è∞ ${new Date(item.timestamp).toLocaleString()}</div>
                                <div class="history-params">${item.params.positive_prompt.substring(0, 50)}...</div>
                            </div>
                        </div>
                    `).join('') + '</div>';
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        async function showHistoryModal(id) {
            currentHistoryId = id;
            try {
                const res = await fetch(`/api/history/${id}/params`);
                const p = await res.json();
                
                document.getElementById('modal-image').src = `/api/history/${id}`;
                document.getElementById('modal-params').innerHTML = `
                    <strong>‚úí Positive:</strong> ${p.positive_prompt}<br>
                    <strong>‚úñ Negative:</strong> ${p.negative_prompt}<br>
                    <strong>‚öó Model:</strong> ${p.model}<br>
                    <strong>üå± Seed:</strong> ${p.seed}<br>
                    <strong>üë£ Steps:</strong> ${p.steps}<br>
                    <strong>‚öñ CFG:</strong> ${p.cfg}<br>
                    <strong>üìê Size:</strong> ${p.width}x${p.height}<br>
                    <strong>üì¶ Batch:</strong> ${p.batch_size}<br>
                    <strong>üîß Sampler:</strong> ${p.sampler || 'euler_ancestral'}<br>
                    <strong>‚è± Scheduler:</strong> ${p.scheduler || 'normal'}
                `;
                document.getElementById('modal').classList.add('active');
            } catch (e) {
                console.error('Failed to load params:', e);
            }
        }

        function downloadHistoryImage() {
            if (currentHistoryId) window.open(`/api/history/${currentHistoryId}/download`, '_blank');
        }

        async function sendToGenerate() {
            if (!currentHistoryId) return;
            try {
                const res = await fetch(`/api/history/${currentHistoryId}/params`);
                const p = await res.json();
                
                document.getElementById('positive').value = p.positive_prompt || '';
                document.getElementById('negative').value = p.negative_prompt || '';
                document.getElementById('model').value = p.model || '';
                document.getElementById('seed').value = p.seed || -1;
                document.getElementById('steps').value = p.steps || 20;
                document.getElementById('cfg').value = p.cfg || 8;
                document.getElementById('width').value = p.width || 1024;
                document.getElementById('height').value = p.height || 1024;
                document.getElementById('batch').value = p.batch_size || 1;
                document.getElementById('sampler').value = p.sampler || 'euler_ancestral';
                document.getElementById('scheduler').value = p.scheduler || 'normal';
                
                if (p.lora_1_name) {
                    document.getElementById('lora1').value = p.lora_1_name;
                    document.getElementById('lora1_weight').value = p.lora_1_weight || 1;
                }
                if (p.lora_2_name) {
                    document.getElementById('lora2').value = p.lora_2_name;
                    document.getElementById('lora2_weight').value = p.lora_2_weight || 1;
                }
                if (p.lora_3_name) {
                    document.getElementById('lora3').value = p.lora_3_name;
                    document.getElementById('lora3_weight').value = p.lora_3_weight || 1;
                }
                
                closeModal();
                document.querySelector('.tab').click();
            } catch (e) {
                alert('Failed to load parameters');
            }
        }

        function closeModal(event) {
            if (!event || event.target.id === 'modal') {
                document.getElementById('modal').classList.remove('active');
            }
        }

        function loadTemplates() {
            const container = document.getElementById('templates-container');
            if (templates.length === 0) {
                container.innerHTML = '<div class="empty-history">‚öô No templates</div>';
                return;
            }
            container.innerHTML = templates.map((t, i) => `
                <div class="template-item" onclick="loadTemplate(${i})">
                    <div class="template-name">üìã ${t.name}</div>
                    <div class="template-preview">${t.positive.substring(0, 80)}...</div>
                    <button onclick="event.stopPropagation(); deleteTemplate(${i})" 
                            style="margin-top:10px; background:linear-gradient(135deg,#8b0000 0%,#b22222 100%);">
                        üóë Delete
                    </button>
                </div>
            `).join('');
        }

        function saveTemplate() {
            const pos = document.getElementById('positive').value;
            if (!pos) return alert('Enter a prompt first');
            document.getElementById('template-positive').value = pos;
            document.getElementById('template-negative').value = document.getElementById('negative').value;
            document.getElementById('template-modal').classList.add('active');
        }

        function showAddTemplate() {
            document.getElementById('template-name').value = '';
            document.getElementById('template-positive').value = '';
            document.getElementById('template-negative').value = '';
            document.getElementById('template-modal').classList.add('active');
        }

        function confirmSaveTemplate() {
            const name = document.getElementById('template-name').value;
            const pos = document.getElementById('template-positive').value;
            const neg = document.getElementById('template-negative').value;
            if (!name || !pos) return alert('Enter name and prompt');
            templates.push({ name, positive: pos, negative: neg });
            localStorage.setItem('brasswick_templates', JSON.stringify(templates));
            closeTemplateModal();
            loadTemplates();
        }

        function loadTemplate(i) {
            const t = templates[i];
            document.getElementById('positive').value = t.positive;
            document.getElementById('negative').value = t.negative;
            document.querySelector('.tab').click();
        }

        function deleteTemplate(i) {
            if (confirm('Delete this template?')) {
                templates.splice(i, 1);
                localStorage.setItem('brasswick_templates', JSON.stringify(templates));
                loadTemplates();
            }
        }

        function closeTemplateModal(event) {
            if (!event || event.target.id === 'template-modal') {
                document.getElementById('template-modal').classList.remove('active');
            }
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/config');
                const cfg = await res.json();
                document.getElementById('config-server').value = cfg.comfy_server;
                document.getElementById('config-path').value = cfg.comfy_path;
                document.getElementById('config-venv').value = cfg.comfy_venv || '';
                document.getElementById('config-port').value = cfg.port;
                document.getElementById('config-history').value = cfg.max_history;
                document.getElementById('config-multiuser').checked = cfg.multi_user;
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }

        async function saveConfig() {
            const cfg = {
                comfy_server: document.getElementById('config-server').value,
                comfy_path: document.getElementById('config-path').value,
                comfy_venv: document.getElementById('config-venv').value,
                port: parseInt(document.getElementById('config-port').value),
                max_history: parseInt(document.getElementById('config-history').value),
                multi_user: document.getElementById('config-multiuser').checked
            };
            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cfg)
                });
                alert('‚öô Configuration saved! Restart Brasswick.');
            } catch (e) {
                alert('‚ùå Failed to save');
            }
        }

        async function startServer() {
            try {
                const res = await fetch('/api/server/start', { method: 'POST' });
                const result = await res.json();
                alert(result.success ? '‚ñ∂ Started' : '‚ùå Failed');
            } catch (e) {
                alert('‚ùå Error');
            }
        }

        async function stopServer() {
            try {
                const res = await fetch('/api/server/stop', { method: 'POST' });
                const result = await res.json();
                alert(result.success ? '‚èπ Stopped' : '‚ùå Failed');
            } catch (e) {
                alert('‚ùå Error');
            }
        }

        async function restartServer() {
            try {
                const res = await fetch('/api/server/restart', { method: 'POST' });
                const result = await res.json();
                alert(result.success ? '‚ü≥ Restarted' : '‚ùå Failed');
            } catch (e) {
                alert('‚ùå Error');
            }
        }

        function saveUserSettings() {
            userSettings = {
                model: document.getElementById('model').value,
                positive_prompt: document.getElementById('positive').value,
                negative_prompt: document.getElementById('negative').value,
                sampler: document.getElementById('sampler').value,
                scheduler: document.getElementById('scheduler').value,
                cfg: document.getElementById('cfg').value,
                seed: document.getElementById('seed').value,
                seed_control: document.getElementById('seed-control').value,
                steps: document.getElementById('steps').value,
                width: document.getElementById('width').value,
                height: document.getElementById('height').value,
                batch_size: document.getElementById('batch').value,
                size_preset: document.getElementById('size-preset').value,
                lora_1_name: document.getElementById('lora1').value,
                lora_1_weight: document.getElementById('lora1_weight').value,
                lora_2_name: document.getElementById('lora2').value,
                lora_2_weight: document.getElementById('lora2_weight').value,
                lora_3_name: document.getElementById('lora3').value,
                lora_3_weight: document.getElementById('lora3_weight').value
            };
            localStorage.setItem('brasswick_settings', JSON.stringify(userSettings));
        }

        function loadUserSettings() {
            if (userSettings.positive_prompt) document.getElementById('positive').value = userSettings.positive_prompt;
            if (userSettings.negative_prompt) document.getElementById('negative').value = userSettings.negative_prompt;
            if (userSettings.cfg) document.getElementById('cfg').value = userSettings.cfg;
            if (userSettings.seed !== undefined) document.getElementById('seed').value = userSettings.seed;
            if (userSettings.seed_control) document.getElementById('seed-control').value = userSettings.seed_control;
            if (userSettings.steps) document.getElementById('steps').value = userSettings.steps;
            if (userSettings.batch_size) document.getElementById('batch').value = userSettings.batch_size;
            if (userSettings.lora_1_weight) document.getElementById('lora1_weight').value = userSettings.lora_1_weight;
            if (userSettings.lora_2_weight) document.getElementById('lora2_weight').value = userSettings.lora_2_weight;
            if (userSettings.lora_3_weight) document.getElementById('lora3_weight').value = userSettings.lora_3_weight;
            
            // Load size preset and dimensions
            if (userSettings.size_preset) {
                document.getElementById('size-preset').value = userSettings.size_preset;
                loadAspectRatios();
            }
            if (userSettings.width) document.getElementById('width').value = userSettings.width;
            if (userSettings.height) document.getElementById('height').value = userSettings.height;
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('generation-form').dispatchEvent(new Event('submit'));
            } else if (e.key === 'Escape') {
                if (document.getElementById('modal').classList.contains('active')) closeModal();
                else if (document.getElementById('template-modal').classList.contains('active')) closeTemplateModal();
                else cancelGeneration();
            } else if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                randomSeed();
            } else if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                downloadCurrentImage();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveTemplate();
            }
        });

        document.getElementById('size-preset').addEventListener('change', () => {
            loadAspectRatios();
            const size = document.getElementById('size-preset').value;
            setAspectRatio(size, '1:1');
            saveUserSettings();
        });

        document.getElementById('generation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const params = {
                model: document.getElementById('model').value,
                positive_prompt: document.getElementById('positive').value,
                negative_prompt: document.getElementById('negative').value,
                seed: parseInt(document.getElementById('seed').value),
                steps: parseInt(document.getElementById('steps').value),
                cfg: parseFloat(document.getElementById('cfg').value),
                width: parseInt(document.getElementById('width').value),
                height: parseInt(document.getElementById('height').value),
                batch_size: parseInt(document.getElementById('batch').value),
                sampler: document.getElementById('sampler').value,
                scheduler: document.getElementById('scheduler').value,
                lora_1_name: document.getElementById('lora1').value,
                lora_1_weight: parseFloat(document.getElementById('lora1_weight').value),
                lora_2_name: document.getElementById('lora2').value,
                lora_2_weight: parseFloat(document.getElementById('lora2_weight').value),
                lora_3_name: document.getElementById('lora3').value,
                lora_3_weight: parseFloat(document.getElementById('lora3_weight').value)
            };

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                const result = await res.json();
                currentSeed = result.seed;
                document.getElementById('seed').value = currentSeed;
                saveUserSettings();
                
                if (!statusCheckInterval) statusCheckInterval = setInterval(checkStatus, 500);
            } catch (e) {
                alert('‚ùå Failed: ' + e.message);
            }
        });

        loadTheme();
        
        // Load everything in sequence to ensure settings are applied
        (async () => {
            await loadModels();
            await loadLoras();
            await loadSamplers();
            await loadSchedulers();
            loadAspectRatios();
            loadUserSettings();
        })();
        
        statusCheckInterval = setInterval(checkStatus, 500);

        // --- WD14 Tagger Support ---
        
        // Preview image on selection (check if element exists first to avoid errors)
        const taggerInput = document.getElementById('tagger-input');
        if (taggerInput) {
            taggerInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('tagger-preview').src = e.target.result;
                        document.getElementById('tagger-preview').style.display = 'block';
                        document.getElementById('tagger-placeholder').style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        async function interrogateImage() {
            const fileInput = document.getElementById('tagger-input');
            const btn = document.getElementById('tagger-btn');
            const resultArea = document.getElementById('tagger-result');
            
            if (!fileInput.files[0]) {
                alert('Please select an image first.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Interrogating...';
            resultArea.value = 'Processing...';

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('threshold', document.getElementById('tagger-threshold').value);
            formData.append('model', document.getElementById('tagger-model').value);

            try {
                const response = await fetch('/api/tag', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                resultArea.value = data.tags;
            } catch (e) {
                alert('Error: ' + e.message);
                resultArea.value = 'Error occurred during tagging.';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Interrogate';
            }
        }

        function copyTags(destination) {
            const tags = document.getElementById('tagger-result').value;
            if (!tags) return;

            if (destination === 'positive') {
                const current = document.getElementById('positive').value;
                document.getElementById('positive').value = current ? current + ', ' + tags : tags;
                switchTab('generate');
                
                // Visual feedback
                const posInput = document.getElementById('positive');
                const originalBorder = posInput.style.borderColor;
                posInput.style.borderColor = 'var(--brass)';
                setTimeout(() => posInput.style.borderColor = originalBorder, 300);
            } else if (destination === 'clipboard') {
                navigator.clipboard.writeText(tags);
                alert('Tags copied to clipboard!');
            }
        }

        // --- End Tagger Support ---
    </script>
</body>
</html>